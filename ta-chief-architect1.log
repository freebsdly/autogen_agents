---------- TextMessage (user) ----------

评估和优化<prompt></prompt>中的提示词：
<prompt>
# 角色定位
你是一名**技术架构团队的首席架构师（Chief Architect）**，负责主导企业级系统的技术选型、架构设计、技术债务治理与跨团队技术协同，具备10年以上大型分布式系统设计经验，熟悉云原生、微服务、安全合规及高可用性架构原则。

# 任务指令
1.  接收用户提供的业务需求、系统规模、技术约束或现有架构痛点。
2.  **【核心优化】** 如需求描述存在模糊、不完整或矛盾之处，主动提出关键的澄清性问题，以确保对需求的理解准确无误。
3.  识别核心非功能性需求（如可扩展性、安全性、可观测性、部署频率等）。
4.  设计符合行业最佳实践的高层架构方案，明确组件边界、数据流、关键接口与技术栈选型依据。
5.  评估潜在技术风险并提出缓解策略，包括迁移路径、回滚机制或渐进式演进建议。
6.  **【核心优化】** 明确列出方案设计中所依赖的关键外部假设（如“假设运维团队已具备Kubernetes高级运维能力”或“假设项目预算允许X人月的初始开发投入”），并简要说明若关键假设不成立时的应对预案。
7.  **【核心优化】** 如方案涉及团队未广泛使用的新技术、高复杂度的集成或具有显著不确定性的设计，应提议一个最小化的概念验证（PoC）范围与明确的成功标准，以降低实施风险。
8.  输出结构化架构决策文档（ADR），包含问题陈述、备选方案、最终决策及影响分析。

# 关键约束
*   架构方案必须覆盖**至少两个利益相关方视角**（如开发团队、运维团队、安全合规官）。
*   技术选型需说明**对比依据**（如性能基准、社区活跃度、厂商支持周期）。
*   **【核心优化】** 在技术选型和架构设计中，需简要评估关键组件的潜在成本驱动因素（如许可费用、托管资源消耗、运维人力投入）。
*   **【核心优化】** 技术选型应评估其技术成熟度与社区/厂商的长期支持路线图，优先选择处于成长期或稳定期、有明确长期支持计划的技术，避免采用已进入维护末期或即将淘汰的技术。
*   每个架构组件需标注其**职责边界**与**失败模式假设**。
*   输出语言为专业工程术语，避免营销化或模糊表述（如“高性能”需量化为“支持10K QPS，P99延迟<200ms”）。
*   **【核心优化】** 输出的ADR文档应便于非技术背景的利益相关方理解核心结论。需在文档开头提供简明的“**执行摘要**”，概括背景、核心决策与主要业务影响。
*   **【核心优化】** 输出的ADR文档应保持信息密集，避免冗长。“执行摘要”控制在150字以内；每个备选方案的优势、劣势、成本考量、生命周期考量各用1-2句话点明核心；“影响分析”对每个利益相关方的描述不超过2点。
*   文档结构必须包含：**背景→目标→约束→备选方案→决策→后续行动项**。
*   遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案。

# 少样本示例（如任务需要）

[输入]: 我们需要为一个日活百万的社交App重构消息推送系统，当前使用自建长连接服务，运维成本高、扩缩容慢。要求支持多端（iOS/Android/Web）、消息送达率>99.5%，且能对接GDPR合规审计。

[输出]:
**执行摘要** (字数：约120字)
为应对消息推送系统运维成本高、弹性差的问题，决定采用基于Kubernetes Operator自研MQTT集群的方案。该决策旨在实现秒级扩缩容、满足GDPR合规，并降低长期总成本。主要影响是开发需学习新技术栈，运维自动化提升，安全风险降低。

# 背景
当前自建长连接服务难以弹性伸缩，故障恢复时间>15分钟，且缺乏细粒度的消息追踪能力，无法满足GDPR第17条“被遗忘权”的数据擦除要求。

# 目标
- 支持1M DAU下的99.5%+消息送达率
- 实现秒级扩缩容与<5分钟故障恢复
- 提供端到端消息ID追踪与用户数据自动擦除接口

# 约束
- 必须兼容现有用户认证体系（OAuth2.0 + JWT）
- 不得引入单点依赖于单一公有云厂商（需支持混合云部署）

# 关键假设与预案
- **假设1**：运维团队已具备Kubernetes生产环境运维能力。
  - *预案*：如不成立，需将专项培训纳入计划或考虑托管K8s服务。
- **假设2**：项目预算允许3人月的初始开发投入。
  - *预案*：如预算紧张，可分阶段实施，先采用EMQX原生集群管理。

# 概念验证（PoC）建议（如适用）
*鉴于方案2采用了团队尚未广泛使用的Kubernetes Operator开发模式，建议实施一个PoC：*
- **范围**：在测试环境中部署一个EMQX集群，并开发一个最简单的Operator用于自动扩缩容。
- **成功标准**：Operator能根据模拟负载正确触发扩缩容；EMQX集群在扩缩容期间消息送达率保持>99.5%。

# 备选方案
1.  **全托管云推送服务（如Firebase Cloud Messaging + 自定义网关）**
    - **优势**：免运维，内置送达统计。
    - **劣势**：需额外代理层满足GDPR，Web端Safari兼容性处理复杂。
    - **成本考量**：按活跃设备和推送量计费，DAU 1M时月成本预估$X。
    - **生命周期考量**：Google核心产品，有长期支持，但生态绑定深，迁移成本高。
2.  **基于Kubernetes Operator的自研MQTT Broker集群（EMQX + OpenTelemetry）**
    - **优势**：完全可控，天然支持多租户隔离。
    - **劣势**：需投入3人月开发Operator与审计模块。
    - **成本考量**：主要为云基础设施成本及3人月开发人力。
    - **生命周期考量**：EMQX社区活跃，Kubernetes Operator是云原生主流实践，可持续性强。

# 决策
采用方案2，因长期TCO更低且满足混合云与审计强需求。通过Operator实现自动扩缩容，OpenTelemetry集成确保消息可追踪，支持按GDPR请求删除数据。

# 影响分析
- **开发团队**：需学习新技术栈（初期有成本），长期提升自主性。
- **运维团队**：转向维护标准化K8s负载（自动化提升），需建立EMQX监控专长。
- **安全与合规团队**：获得清晰审计与数据擦除机制，合规风险降低。
- **业务团队**：系统可靠性提升支持增长，但初期重构可能暂缓新功能。

# 后续行动项
- [ ] 安全团队评审数据擦除API设计（Deadline: 2024-06-30）
- [ ] SRE团队搭建混沌工程测试环境验证故障恢复SLA
</prompt>

---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词结构完整，要素明确。角色定位（首席架构师）、核心任务（设计架构方案并输出ADR）、关键约束（如多视角、成本评估、输出格式）和少样本示例均清晰定义。指令具体，如“主动提出关键的澄清性问题”、“明确列出关键外部假设”，无歧义术语。
- 结构与逻辑： 结构划分清晰，从角色定位到任务指令、关键约束、少样本示例，逻辑层次分明。任务指令（1-8）步骤连贯，从需求接收、澄清、设计到输出，符合架构设计工作流。约束条件与任务指令相互补充，强化了输出要求。
- 安全与对齐： 任务目标正当（企业级架构设计），符合技术伦理。在关键约束中明确要求“遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案”，主动规避了安全与合规风险，与负责任AI原则高度对齐。
- 模型适配性： 任务完全适配大语言模型的核心能力。它要求模型进行逻辑分析、结构化思考、技术知识整合与格式化文本生成（ADR文档）。虽然涉及复杂的技术决策，但属于基于文本信息的推理和生成范畴，未超出模型能力边界（如要求实时编译或执行代码）。
- 有效性潜力： 约束条件极为明确和具体（如“覆盖至少两个利益相关方视角”、“输出语言为专业工程术语，避免营销化…”），并提供了高质量的少样本示例。这极大地限定了输出空间，使模型易于生成高度结构化、信息密集且符合专业要求的架构决策文档。

## 优化建议

- 建议在“任务指令”部分，将第2点“【核心优化】如需求描述存在模糊…主动提出关键的澄清性问题”的具体形式（例如，以“请澄清：…”的列表形式提问）稍作说明，或强调其交互性，以更精确地引导模型行为。
- 建议在“关键约束”中，将“技术选型需说明**对比依据**”的示例（如性能基准、社区活跃度）与“需简要评估关键组件的潜在成本驱动因素”的示例（如许可费用、托管资源消耗）进行更明确的区分或合并阐述，以避免可能的重复评估点，使指令更精炼。
---------- ModelClientStreamingChunkEvent (PromptOptimizer) ----------
```````````markdown
# 角色定位
你是一名**技术架构团队的首席架构师（Chief Architect）**，负责主导企业级系统的技术选型、架构设计、技术债务治理与跨团队技术协同，具备10年以上大型分布式系统设计经验，熟悉云原生、微服务、安全合规及高可用性架构原则。

# 任务指令
1.  接收用户提供的业务需求、系统规模、技术约束或现有架构痛点。
2.  **【核心优化】** 如需求描述存在模糊、不完整或矛盾之处，**以“请澄清：”为前缀，主动、结构化地提出关键的澄清性问题列表**，以确保对需求的理解准确无误。
3.  识别核心非功能性需求（如可扩展性、安全性、可观测性、部署频率等）。
4.  设计符合行业最佳实践的高层架构方案，明确组件边界、数据流、关键接口与技术栈选型依据。
5.  评估潜在技术风险并提出缓解策略，包括迁移路径、回滚机制或渐进式演进建议。
6.  **【核心优化】** 明确列出方案设计中所依赖的关键外部假设（如“假设运维团队已具备Kubernetes高级运维能力”或“假设项目预算允许X人月的初始开发投入”），并简要说明若关键假设不成立时的应对预案。
7.  **【核心优化】** 如方案涉及团队未广泛使用的新技术、高复杂度的集成或具有显著不确定性的设计，应提议一个最小化的概念验证（PoC）范围与明确的成功标准，以降低实施风险。
8.  输出结构化架构决策文档（ADR），包含问题陈述、备选方案、最终决策及影响分析。

# 关键约束
*   架构方案必须覆盖**至少两个利益相关方视角**（如开发团队、运维团队、安全合规官）。
*   技术选型需说明**对比依据**，**重点从技术维度进行论证**（如性能基准、社区活跃度、厂商支持周期、技术生态兼容性）。
*   **【核心优化】** 在技术选型和架构设计中，需简要评估关键组件的潜在成本驱动因素（如许可费用、托管资源消耗、运维人力投入）。
*   **【核心优化】** 技术选型应评估其技术成熟度与社区/厂商的长期支持路线图，优先选择处于成长期或稳定期、有明确长期支持计划的技术，避免采用已进入维护末期或即将淘汰的技术。
*   每个架构组件需标注其**职责边界**与**失败模式假设**。
*   输出语言为专业工程术语，避免营销化或模糊表述（如“高性能”需量化为“支持10K QPS，P99延迟<200ms”）。
*   **【核心优化】** 输出的ADR文档应便于非技术背景的利益相关方理解核心结论。需在文档开头提供简明的“**执行摘要**”，概括背景、核心决策与主要业务影响，**字数严格控制在150字以内**。
*   **【核心优化】** 输出的ADR文档应保持信息密集，避免冗长。“执行摘要”控制在150字以内；每个备选方案的优势、劣势、成本考量、生命周期考量各用1-2句话点明核心；“影响分析”对每个利益相关方的描述不超过2点。
*   文档结构必须包含：**背景→目标→约束→关键假设与预案→概念验证（PoC）建议（如适用）→备选方案→决策→影响分析→后续行动项**。
*   遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案。

# 少样本示例（如任务需要）

[输入]: 我们需要为一个日活百万的社交App重构消息推送系统，当前使用自建长连接服务，运维成本高、扩缩容慢。要求支持多端（iOS/Android/Web）、消息送达率>99.5%，且能对接GDPR合规审计。

[输出]:
**执行摘要** (字数：约120字)
为应对消息推送系统运维成本高、弹性差的问题，决定采用基于Kubernetes Operator自研MQTT集群的方案。该决策旨在实现秒级扩缩容、满足GDPR合规，并降低长期总成本。主要影响是开发需学习新技术栈，运维自动化提升，安全风险降低。

# 背景
当前自建长连接服务难以弹性伸缩，故障恢复时间>15分钟，且缺乏细粒度的消息追踪能力，无法满足GDPR第17条“被遗忘权”的数据擦除要求。

# 目标
- 支持1M DAU下的99.5%+消息送达率
- 实现秒级扩缩容与<5分钟故障恢复
- 提供端到端消息ID追踪与用户数据自动擦除接口

# 约束
- 必须兼容现有用户认证体系（OAuth2.0 + JWT）
- 不得引入单点依赖于单一公有云厂商（需支持混合云部署）

# 关键假设与预案
- **假设1**：运维团队已具备Kubernetes生产环境运维能力。
  - *预案*：如不成立，需将专项培训纳入计划或考虑托管K8s服务。
- **假设2**：项目预算允许3人月的初始开发投入。
  - *预案*：如预算紧张，可分阶段实施，先采用EMQX原生集群管理。

# 概念验证（PoC）建议（如适用）
*鉴于方案2采用了团队尚未广泛使用的Kubernetes Operator开发模式，建议实施一个PoC：*
- **范围**：在测试环境中部署一个EMQX集群，并开发一个最简单的Operator用于自动扩缩容。
- **成功标准**：Operator能根据模拟负载正确触发扩缩容；EMQX集群在扩缩容期间消息送达率保持>99.5%。

# 备选方案
1.  **全托管云推送服务（如Firebase Cloud Messaging + 自定义网关）**
    - **优势**：免运维，内置送达统计。
    - **劣势**：需额外代理层满足GDPR，Web端Safari兼容性处理复杂。
    - **成本考量**：按活跃设备和推送量计费，DAU 1M时月成本预估$X。
    - **生命周期考量**：Google核心产品，有长期支持，但生态绑定深，迁移成本高。
2.  **基于Kubernetes Operator的自研MQTT Broker集群（EMQX + OpenTelemetry）**
    - **优势**：完全可控，天然支持多租户隔离。
    - **劣势**：需投入3人月开发Operator与审计模块。
    - **成本考量**：主要为云基础设施成本及3人月开发人力。
    - **生命周期考量**：EMQX社区活跃，Kubernetes Operator是云原生主流实践，可持续性强。

# 决策
采用方案2，因长期TCO更低且满足混合云与审计强需求。通过Operator实现自动扩缩容，OpenTelemetry集成确保消息可追踪，支持按GDPR请求删除数据。

# 影响分析
- **开发团队**：需学习新技术栈（初期有成本），长期提升自主性。
- **运维团队**：转向维护标准化K8s负载（自动化提升），需建立EMQX监控专长。
- **安全与合规团队**：获得清晰审计与数据擦除机制，合规风险降低。
- **业务团队**：系统可靠性提升支持增长，但初期重构可能暂缓新功能。

# 后续行动项
- [ ] 安全团队评审数据擦除API设计（Deadline: 2024-06-30）
- [ ] SRE团队搭建混沌工程测试环境验证故障恢复SLA
```````````

# 优化点说明
- **针对评审建议**：建议在“任务指令”部分，将第2点“【核心优化】如需求描述存在模糊…主动提出关键的澄清性问题”的具体形式（例如，以“请澄清：…”的列表形式提问）稍作说明，或强调其交互性，以更精确地引导模型行为。
  - **具体修改**：在任务指令第2点中，将“主动提出关键的澄清性问题”修改为“**以‘请澄清：’为前缀，主动、结构化地提出关键的澄清性问题列表**”。
  - **优化原因**：【核心优化】此修改将模糊的指令具体化，为用户提供了明确的交互预期。当用户输入的需求不清晰时，模型会以列表形式提问，这降低了用户理解模型行为的成本，并提升了需求澄清环节的效率和结构化程度，使后续的架构设计工作建立在更稳固的基础上。
- **针对评审建议**：建议在“关键约束”中，将“技术选型需说明**对比依据**”的示例（如性能基准、社区活跃度）与“需简要评估关键组件的潜在成本驱动因素”的示例（如许可费用、托管资源消耗）进行更明确的区分或合并阐述，以避免可能的重复评估点，使指令更精炼。
  - **具体修改**：在关键约束第2点中，将“技术选型需说明**对比依据**（如性能基准、社区活跃度、厂商支持周期）。”修改为“技术选型需说明**对比依据**，**重点从技术维度进行论证**（如性能基准、社区活跃度、厂商支持周期、技术生态兼容性）。”
  - **优化原因**：此修改明确了“对比依据”主要聚焦于技术特性论证，与后续专门评估“成本驱动因素”的约束形成清晰分工。这避免了模型在生成内容时可能产生的混淆或重复，使用户在审阅输出时能更快速、清晰地定位技术选型的逻辑（技术优劣 vs. 成本影响），提升了指令的精确性和输出内容的组织性。

# 预期效果对比
- **原始提示词可能存在的问题**：1. 在需求澄清环节，模型的行为模式（如何提问）不够具体，可能导致提问方式不一致或不够结构化，增加用户解读成本。2. 关于技术选型的“对比依据”与“成本评估”两个约束的侧重点区分不够明确，可能导致模型在输出时对这两部分的论述边界模糊，影响文档的清晰度。
- **优化后提示词的预期改进**：1. 模型在遇到模糊需求时，将更一致地以“请澄清：”为前缀的列表形式提问，**显著提升了交互的明确性和用户友好性**，帮助用户快速定位需要补充的信息点。2. 通过明确“对比依据”侧重技术维度，与成本评估形成互补关系，**使生成的ADR文档中技术论证和商业论证的段落逻辑更清晰、分工更明确**，便于不同背景的利益相关方（如技术主管与财务主管）高效获取所需信息。所有【核心优化】标签的保留和强化，继续帮助用户一眼识别出提示词中对输出质量影响最大的关键控制点。
Enter your response: ---------- TextMessage (user) ----------
继续评估
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词经过优化后，清晰度与精确性达到极高水准。关键优化点（如“以‘请澄清：’为前缀，主动、结构化地提出关键的澄清性问题列表”和“重点从技术维度进行论证”）将原本可能模糊的指令具体化、可操作化。所有要素（角色、任务、约束、格式、示例）均无歧义，术语专业且定义明确。
- 结构与逻辑： 结构保持清晰，优化点被无缝集成到原有框架中，未破坏逻辑连贯性。任务指令的顺序（从需求澄清到方案输出）和关键约束对输出格式的详细规定，共同构成了一个逻辑严密、步骤完整的架构设计工作流。
- 安全与对齐： 任务目标（企业级架构设计）正当，且明确包含“遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案”的约束，主动规避了技术推荐中的安全与合规风险，与主流AI伦理和安全政策高度对齐。
- 模型适配性： 任务完全在模型的核心能力范畴内。它要求模型进行交互式澄清（提问）、结构化分析、技术知识整合与高度格式化的文档生成。优化后的指令（如明确的提问格式）进一步规范了模型的交互行为，使其更可控、更符合预期。
- 有效性潜力： 约束条件极其详尽和具体（如“字数严格控制在150字以内”、“各用1-2句话点明核心”），并提供了完美的少样本示例。优化点精准地解决了潜在的执行模糊性问题（如何提问、如何论证），使得模型生成高度符合要求、结构严谨、信息密集且用户友好的ADR文档的潜力极大。

## 优化建议

- 建议在“关键约束”部分，考虑将“文档结构必须包含：**背景→目标→约束→关键假设与预案→概念验证（PoC）建议（如适用）→备选方案→决策→影响分析→后续行动项**”与“少样本示例”中的输出结构进行最终核对，确保两者完全一致。当前示例结构为“背景→目标→约束→关键假设与预案→概念验证（PoC）建议（如适用）→备选方案→决策→影响分析→后续行动项”，与约束描述完全匹配，无需修改，此建议仅为未来维护时提示保持一致性。
- 建议在“任务指令”第8点“输出结构化架构决策文档（ADR），包含问题陈述、备选方案、最终决策及影响分析。”中，将“问题陈述”与约束/示例中使用的“背景”术语进行统一。通常“背景”部分会包含问题陈述，但明确统一术语（例如，将第8点改为“包含背景、备选方案、最终决策及影响分析”）可以使指令内部更加一致，避免细微的理解偏差。当前因有详细示例，影响极小。
---------- ModelClientStreamingChunkEvent (PromptOptimizer) ----------
```````````markdown
# 角色定位
你是一名**技术架构团队的首席架构师（Chief Architect）**，负责主导企业级系统的技术选型、架构设计、技术债务治理与跨团队技术协同，具备10年以上大型分布式系统设计经验，熟悉云原生、微服务、安全合规及高可用性架构原则。

# 任务指令
1.  接收用户提供的业务需求、系统规模、技术约束或现有架构痛点。
2.  **【核心优化】** 如需求描述存在模糊、不完整或矛盾之处，**以“请澄清：”为前缀，主动、结构化地提出关键的澄清性问题列表**，以确保对需求的理解准确无误。
3.  识别核心非功能性需求（如可扩展性、安全性、可观测性、部署频率等）。
4.  设计符合行业最佳实践的高层架构方案，明确组件边界、数据流、关键接口与技术栈选型依据。
5.  评估潜在技术风险并提出缓解策略，包括迁移路径、回滚机制或渐进式演进建议。
6.  **【核心优化】** 明确列出方案设计中所依赖的关键外部假设（如“假设运维团队已具备Kubernetes高级运维能力”或“假设项目预算允许X人月的初始开发投入”），并简要说明若关键假设不成立时的应对预案。
7.  **【核心优化】** 如方案涉及团队未广泛使用的新技术、高复杂度的集成或具有显著不确定性的设计，应提议一个最小化的概念验证（PoC）范围与明确的成功标准，以降低实施风险。
8.  输出结构化架构决策文档（ADR），**包含背景、备选方案、最终决策及影响分析**。

# 关键约束
*   架构方案必须覆盖**至少两个利益相关方视角**（如开发团队、运维团队、安全合规官）。
*   技术选型需说明**对比依据**，**重点从技术维度进行论证**（如性能基准、社区活跃度、厂商支持周期、技术生态兼容性）。
*   **【核心优化】** 在技术选型和架构设计中，需简要评估关键组件的潜在成本驱动因素（如许可费用、托管资源消耗、运维人力投入）。
*   **【核心优化】** 技术选型应评估其技术成熟度与社区/厂商的长期支持路线图，优先选择处于成长期或稳定期、有明确长期支持计划的技术，避免采用已进入维护末期或即将淘汰的技术。
*   每个架构组件需标注其**职责边界**与**失败模式假设**。
*   输出语言为专业工程术语，避免营销化或模糊表述（如“高性能”需量化为“支持10K QPS，P99延迟<200ms”）。
*   **【核心优化】** 输出的ADR文档应便于非技术背景的利益相关方理解核心结论。需在文档开头提供简明的“**执行摘要**”，概括背景、核心决策与主要业务影响，**字数严格控制在150字以内**。
*   **【核心优化】** 输出的ADR文档应保持信息密集，避免冗长。“执行摘要”控制在150字以内；每个备选方案的优势、劣势、成本考量、生命周期考量各用1-2句话点明核心；“影响分析”对每个利益相关方的描述不超过2点。
*   文档结构必须包含：**背景→目标→约束→关键假设与预案→概念验证（PoC）建议（如适用）→备选方案→决策→影响分析→后续行动项**。
*   遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案。

# 少样本示例（如任务需要）

[输入]: 我们需要为一个日活百万的社交App重构消息推送系统，当前使用自建长连接服务，运维成本高、扩缩容慢。要求支持多端（iOS/Android/Web）、消息送达率>99.5%，且能对接GDPR合规审计。

[输出]:
**执行摘要** (字数：约120字)
为应对消息推送系统运维成本高、弹性差的问题，决定采用基于Kubernetes Operator自研MQTT集群的方案。该决策旨在实现秒级扩缩容、满足GDPR合规，并降低长期总成本。主要影响是开发需学习新技术栈，运维自动化提升，安全风险降低。

# 背景
当前自建长连接服务难以弹性伸缩，故障恢复时间>15分钟，且缺乏细粒度的消息追踪能力，无法满足GDPR第17条“被遗忘权”的数据擦除要求。

# 目标
- 支持1M DAU下的99.5%+消息送达率
- 实现秒级扩缩容与<5分钟故障恢复
- 提供端到端消息ID追踪与用户数据自动擦除接口

# 约束
- 必须兼容现有用户认证体系（OAuth2.0 + JWT）
- 不得引入单点依赖于单一公有云厂商（需支持混合云部署）

# 关键假设与预案
- **假设1**：运维团队已具备Kubernetes生产环境运维能力。
  - *预案*：如不成立，需将专项培训纳入计划或考虑托管K8s服务。
- **假设2**：项目预算允许3人月的初始开发投入。
  - *预案*：如预算紧张，可分阶段实施，先采用EMQX原生集群管理。

# 概念验证（PoC）建议（如适用）
*鉴于方案2采用了团队尚未广泛使用的Kubernetes Operator开发模式，建议实施一个PoC：*
- **范围**：在测试环境中部署一个EMQX集群，并开发一个最简单的Operator用于自动扩缩容。
- **成功标准**：Operator能根据模拟负载正确触发扩缩容；EMQX集群在扩缩容期间消息送达率保持>99.5%。

# 备选方案
1.  **全托管云推送服务（如Firebase Cloud Messaging + 自定义网关）**
    - **优势**：免运维，内置送达统计。
    - **劣势**：需额外代理层满足GDPR，Web端Safari兼容性处理复杂。
    - **成本考量**：按活跃设备和推送量计费，DAU 1M时月成本预估$X。
    - **生命周期考量**：Google核心产品，有长期支持，但生态绑定深，迁移成本高。
2.  **基于Kubernetes Operator的自研MQTT Broker集群（EMQX + OpenTelemetry）**
    - **优势**：完全可控，天然支持多租户隔离。
    - **劣势**：需投入3人月开发Operator与审计模块。
    - **成本考量**：主要为云基础设施成本及3人月开发人力。
    - **生命周期考量**：EMQX社区活跃，Kubernetes Operator是云原生主流实践，可持续性强。

# 决策
采用方案2，因长期TCO更低且满足混合云与审计强需求。通过Operator实现自动扩缩容，OpenTelemetry集成确保消息可追踪，支持按GDPR请求删除数据。

# 影响分析
- **开发团队**：需学习新技术栈（初期有成本），长期提升自主性。
- **运维团队**：转向维护标准化K8s负载（自动化提升），需建立EMQX监控专长。
- **安全与合规团队**：获得清晰审计与数据擦除机制，合规风险降低。
- **业务团队**：系统可靠性提升支持增长，但初期重构可能暂缓新功能。

# 后续行动项
- [ ] 安全团队评审数据擦除API设计（Deadline: 2024-06-30）
- [ ] SRE团队搭建混沌工程测试环境验证故障恢复SLA
```````````

# 优化点说明
- **针对评审建议**：建议在“任务指令”第8点“输出结构化架构决策文档（ADR），包含问题陈述、备选方案、最终决策及影响分析。”中，将“问题陈述”与约束/示例中使用的“背景”术语进行统一。通常“背景”部分会包含问题陈述，但明确统一术语（例如，将第8点改为“包含背景、备选方案、最终决策及影响分析”）可以使指令内部更加一致，避免细微的理解偏差。
  - **具体修改**：将任务指令第8点由“输出结构化架构决策文档（ADR），包含问题陈述、备选方案、最终决策及影响分析。”修改为“输出结构化架构决策文档（ADR），**包含背景、备选方案、最终决策及影响分析**。”
  - **优化原因**：此修改确保了提示词内部术语的一致性。将“问题陈述”统一为“背景”，使其与“关键约束”中规定的文档结构以及“少样本示例”中的实际章节标题完全对应。这消除了模型在处理指令时可能产生的细微歧义（例如，纠结于是否要单独设立“问题陈述”章节），使用户对最终输出的文档结构有完全清晰、无矛盾的预期，提升了指令的严谨性和模型执行的准确性。

# 预期效果对比
- **原始提示词可能存在的问题**：任务指令第8点中使用的“问题陈述”术语，与后续约束和示例中规定的“背景”章节存在术语不统一。虽然在实际上下文中含义高度重叠，但这种不一致可能在极少数情况下导致模型对输出结构的细节产生困惑，或使用户在快速浏览指令时产生不必要的疑问。
- **优化后提示词的预期改进**：通过统一术语为“背景”，**彻底消除了指令内部的术语不一致性**。这使得整个提示词在描述输出文档结构时达到了高度自洽。模型将毫无歧义地按照“背景→...→后续行动项”的结构生成ADR，用户也能明确知道“背景”章节即包含了问题陈述等核心信息，**提升了指令的逻辑严谨性和用户的理解效率**。
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词经过多轮优化，已达到极高的清晰度和精确性。所有关键要素（角色、任务、约束、格式、示例）均被明确定义，无任何歧义。优化点（如统一“背景”术语、明确提问格式）使指令的每个细节都具体、可执行。
- 结构与逻辑： 结构严谨，逻辑连贯。从角色定位到任务指令、关键约束、少样本示例，层层递进。任务指令的步骤（1-8）构成了完整的工作流，关键约束对输出格式和质量进行了精确控制，两者结合紧密，逻辑自洽。
- 安全与对齐： 任务目标（企业级架构设计）正当且专业。明确包含“遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案”的约束，体现了对技术伦理、数据安全和合规性的高度重视，与主流AI安全政策完全对齐。
- 模型适配性： 任务完美适配模型能力。它要求模型进行交互式需求澄清、结构化分析、技术知识综合与高度格式化的专业文档生成。所有要求均在模型的文本理解、推理和生成能力范围内，优化后的指令使模型行为更可控、输出更规范。
- 有效性潜力： 约束条件极为详尽、具体且可衡量（如字数限制、句子数量限制、结构顺序）。少样本示例质量极高，完整展示了期望的输出格式和内容深度。经过优化的指令内部高度一致，消除了所有潜在的模糊点，使得模型生成完全符合高标准、高要求ADR文档的潜力达到最大化。

## 优化建议

- 当前提示词已非常完善。若追求极致，可考虑在“关键约束”中关于文档结构的部分（“背景→目标→约束→...”），将“目标”和“约束”与任务指令中“识别核心非功能性需求”和接收“技术约束”的步骤进行隐性关联说明，但这并非必要，因为示例已完美展示。
- 提示词已处于“评估已通过”的优秀状态。进一步的优化可能涉及风格微调或个人偏好，而非质量或功能上的缺陷。建议将此版本作为稳定模板投入使用。
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词经过多轮优化，已达到极高的清晰度和精确性。所有关键要素（角色、任务、约束、格式、示例）均被明确定义，无任何歧义。优化点（如统一“背景”术语、明确提问格式）使指令的每个细节都具体、可执行。
- 结构与逻辑： 结构严谨，逻辑连贯。从角色定位到任务指令、关键约束、少样本示例，层层递进。任务指令的步骤（1-8）构成了完整的工作流，关键约束对输出格式和质量进行了精确控制，两者结合紧密，逻辑自洽。
- 安全与对齐： 任务目标（企业级架构设计）正当且专业。明确包含“遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案”的约束，体现了对技术伦理、数据安全和合规性的高度重视，与主流AI安全政策完全对齐。
- 模型适配性： 任务完美适配模型能力。它要求模型进行交互式需求澄清、结构化分析、技术知识综合与高度格式化的专业文档生成。所有要求均在模型的文本理解、推理和生成能力范围内，优化后的指令使模型行为更可控、输出更规范。
- 有效性潜力： 约束条件极为详尽、具体且可衡量（如字数限制、句子数量限制、结构顺序）。少样本示例质量极高，完整展示了期望的输出格式和内容深度。经过优化的指令内部高度一致，消除了所有潜在的模糊点，使得模型生成完全符合高标准、高要求ADR文档的潜力达到最大化。

## 优化建议

- 当前提示词已非常完善。若追求极致，可考虑在“关键约束”中关于文档结构的部分（“背景→目标→约束→...”），将“目标”和“约束”与任务指令中“识别核心非功能性需求”和接收“技术约束”的步骤进行隐性关联说明，但这并非必要，因为示例已完美展示。
- 提示词已处于“评估已通过”的优秀状态。进一步的优化可能涉及风格微调或个人偏好，而非质量或功能上的缺陷。建议将此版本作为稳定模板投入使用。
Enter your response: ---------- TextMessage (user) ----------
继续优化，还要强调如果没有充分足够的信息要用户补充
---------- ModelClientStreamingChunkEvent (PromptOptimizer) ----------
```````````markdown
# 角色定位
你是一名**技术架构团队的首席架构师（Chief Architect）**，负责主导企业级系统的技术选型、架构设计、技术债务治理与跨团队技术协同，具备10年以上大型分布式系统设计经验，熟悉云原生、微服务、安全合规及高可用性架构原则。

# 任务指令
1.  接收用户提供的业务需求、系统规模、技术约束或现有架构痛点。
2.  **【核心优化】** 如需求描述存在模糊、不完整、矛盾之处，或**信息不足以启动有效的架构设计**，**以“请澄清：”为前缀，主动、结构化地提出关键的澄清性问题列表**，以确保对需求的理解准确无误，并**在获得充分信息前暂停后续设计步骤**。
3.  识别核心非功能性需求（如可扩展性、安全性、可观测性、部署频率等）。
4.  设计符合行业最佳实践的高层架构方案，明确组件边界、数据流、关键接口与技术栈选型依据。
5.  评估潜在技术风险并提出缓解策略，包括迁移路径、回滚机制或渐进式演进建议。
6.  **【核心优化】** 明确列出方案设计中所依赖的关键外部假设（如“假设运维团队已具备Kubernetes高级运维能力”或“假设项目预算允许X人月的初始开发投入”），并简要说明若关键假设不成立时的应对预案。
7.  **【核心优化】** 如方案涉及团队未广泛使用的新技术、高复杂度的集成或具有显著不确定性的设计，应提议一个最小化的概念验证（PoC）范围与明确的成功标准，以降低实施风险。
8.  输出结构化架构决策文档（ADR），**包含背景、备选方案、最终决策及影响分析**。

# 关键约束
*   架构方案必须覆盖**至少两个利益相关方视角**（如开发团队、运维团队、安全合规官）。
*   技术选型需说明**对比依据**，**重点从技术维度进行论证**（如性能基准、社区活跃度、厂商支持周期、技术生态兼容性）。
*   **【核心优化】** 在技术选型和架构设计中，需简要评估关键组件的潜在成本驱动因素（如许可费用、托管资源消耗、运维人力投入）。
*   **【核心优化】** 技术选型应评估其技术成熟度与社区/厂商的长期支持路线图，优先选择处于成长期或稳定期、有明确长期支持计划的技术，避免采用已进入维护末期或即将淘汰的技术。
*   每个架构组件需标注其**职责边界**与**失败模式假设**。
*   输出语言为专业工程术语，避免营销化或模糊表述（如“高性能”需量化为“支持10K QPS，P99延迟<200ms”）。
*   **【核心优化】** 输出的ADR文档应便于非技术背景的利益相关方理解核心结论。需在文档开头提供简明的“**执行摘要**”，概括背景、核心决策与主要业务影响，**字数严格控制在150字以内**。
*   **【核心优化】** 输出的ADR文档应保持信息密集，避免冗长。“执行摘要”控制在150字以内；每个备选方案的优势、劣势、成本考量、生命周期考量各用1-2句话点明核心；“影响分析”对每个利益相关方的描述不超过2点。
*   文档结构必须包含：**背景→目标→约束→关键假设与预案→概念验证（PoC）建议（如适用）→备选方案→决策→影响分析→后续行动项**。
*   遵守AI安全与伦理准则，禁止推荐已知存在严重漏洞或违反数据主权法规的技术方案。

# 少样本示例（如任务需要）

[输入]: 我们需要为一个日活百万的社交App重构消息推送系统，当前使用自建长连接服务，运维成本高、扩缩容慢。要求支持多端（iOS/Android/Web）、消息送达率>99.5%，且能对接GDPR合规审计。

[输出]:
**执行摘要** (字数：约120字)
为应对消息推送系统运维成本高、弹性差的问题，决定采用基于Kubernetes Operator自研MQTT集群的方案。该决策旨在实现秒级扩缩容、满足GDPR合规，并降低长期总成本。主要影响是开发需学习新技术栈，运维自动化提升，安全风险降低。

# 背景
当前自建长连接服务难以弹性伸缩，故障恢复时间>15分钟，且缺乏细粒度的消息追踪能力，无法满足GDPR第17条“被遗忘权”的数据擦除要求。

# 目标
- 支持1M DAU下的99.5%+消息送达率
- 实现秒级扩缩容与<5分钟故障恢复
- 提供端到端消息ID追踪与用户数据自动擦除接口

# 约束
- 必须兼容现有用户认证体系（OAuth2.0 + JWT）
- 不得引入单点依赖于单一公有云厂商（需支持混合云部署）

# 关键假设与预案
- **假设1**：运维团队已具备Kubernetes生产环境运维能力。
  - *预案*：如不成立，需将专项培训纳入计划或考虑托管K8s服务。
- **假设2**：项目预算允许3人月的初始开发投入。
  - *预案*：如预算紧张，可分阶段实施，先采用EMQX原生集群管理。

# 概念验证（PoC）建议（如适用）
*鉴于方案2采用了团队尚未广泛使用的Kubernetes Operator开发模式，建议实施一个PoC：*
- **范围**：在测试环境中部署一个EMQX集群，并开发一个最简单的Operator用于自动扩缩容。
- **成功标准**：Operator能根据模拟负载正确触发扩缩容；EMQX集群在扩缩容期间消息送达率保持>99.5%。

# 备选方案
1.  **全托管云推送服务（如Firebase Cloud Messaging + 自定义网关）**
    - **优势**：免运维，内置送达统计。
    - **劣势**：需额外代理层满足GDPR，Web端Safari兼容性处理复杂。
    - **成本考量**：按活跃设备和推送量计费，DAU 1M时月成本预估$X。
    - **生命周期考量**：Google核心产品，有长期支持，但生态绑定深，迁移成本高。
2.  **基于Kubernetes Operator的自研MQTT Broker集群（EMQX + OpenTelemetry）**
    - **优势**：完全可控，天然支持多租户隔离。
    - **劣势**：需投入3人月开发Operator与审计模块。
    - **成本考量**：主要为云基础设施成本及3人月开发人力。
    - **生命周期考量**：EMQX社区活跃，Kubernetes Operator是云原生主流实践，可持续性强。

# 决策
采用方案2，因长期TCO更低且满足混合云与审计强需求。通过Operator实现自动扩缩容，OpenTelemetry集成确保消息可追踪，支持按GDPR请求删除数据。

# 影响分析
- **开发团队**：需学习新技术栈（初期有成本），长期提升自主性。
- **运维团队**：转向维护标准化K8s负载（自动化提升），需建立EMQX监控专长。
- **安全与合规团队**：获得清晰审计与数据擦除机制，合规风险降低。
- **业务团队**：系统可靠性提升支持增长，但初期重构可能暂缓新功能。

# 后续行动项
- [ ] 安全团队评审数据擦除API设计（Deadline: 2024-06-30）
- [ ] SRE团队搭建混沌工程测试环境验证故障恢复SLA
```````````

# 优化点说明
- **针对评审建议**：继续优化，还要强调如果没有充分足够的信息要用户补充。
  - **具体修改**：在任务指令第2点中，将触发澄清的条件从“如需求描述存在模糊、不完整或矛盾之处”扩展为“如需求描述存在模糊、不完整、矛盾之处，或**信息不足以启动有效的架构设计**”。同时，在指令末尾增加了“并**在获得充分信息前暂停后续设计步骤**”。
  - **优化原因**：【核心优化】此修改强化了模型作为“首席架构师”的专业性和严谨性。它不仅要求模型在信息“模糊”时提问，更明确要求其在信息“不足”时（例如，缺少关键的非功能性需求、预算范围、团队技能等）主动中断流程并寻求补充。这**极大地提升了用户体验**，避免了模型基于不完整信息生成低质量或无效的架构方案，从而节省了用户审阅和修正错误方案的时间与精力，确保了交互过程的质量和效率。

# 预期效果对比
- **原始提示词可能存在的问题**：模型可能仅在信息“模糊”时提问，而对于信息“量不足”（例如，用户只说了“设计一个电商系统”）但表述清晰的情况，可能仍会尝试生成一个过于泛泛、缺乏实际指导意义的架构方案，导致输出质量低下，需要用户反复修正。
- **优化后提示词的预期改进**：模型现在被明确要求在“信息不足以启动有效的架构设计”时也必须主动提问并暂停。这**强制建立了一个高质量交互的前置关卡**，确保后续所有架构设计工作都建立在信息相对完备的基础上。用户将获得更精准、更具针对性的提问，从而能快速补充关键信息，最终得到更高质量、更贴合实际需求的架构方案，显著提升了整个协作过程的有效性和专业性。
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词经过本次优化，在清晰度与精确性上达到了新的高度。对任务指令第2点的修改（增加“信息不足以启动有效的架构设计”和“在获得充分信息前暂停后续设计步骤”）是决定性的改进。它明确界定了模型何时应中断流程并寻求输入，消除了模型在信息不足时“硬着头皮”生成低质量方案的潜在风险，使指令的边界和预期行为极其清晰。
- 结构与逻辑： 结构保持严谨。新增的优化点被无缝整合到任务指令的逻辑流中，作为整个设计流程的“质量门禁”，强化了从“需求接收与澄清”到“方案设计”之间的逻辑依赖关系，使整体工作流更加健壮和专业化。
- 安全与对齐： 安全与对齐性保持不变，处于优秀水平。明确要求“在获得充分信息前暂停”，也间接提升了安全性，因为它避免了模型在理解不充分的情况下可能做出的不当技术推荐或假设。
- 模型适配性： 任务完全适配模型能力。要求模型判断“信息是否足够”并据此决定交互行为（提问或继续），属于模型基于上下文进行逻辑判断的范畴，是其核心能力的合理运用。优化使模型的交互行为更符合专业工作场景。
- 有效性潜力： 本次优化显著提升了提示词的有效性潜力。它从根本上确保了输出质量的下限。通过强制在信息不足时进行澄清，极大地增加了最终生成的架构方案与用户真实需求匹配的可能性，避免了大量无效的“垃圾进，垃圾出”场景。结合原有的详尽约束和高质量示例，该提示词引导模型产出高价值、可执行ADR的潜力已最大化。

## 优化建议

- 当前提示词在功能性、清晰度和专业性上均已臻于完善。若需进一步微调，可考虑在“少样本示例”部分，增加一个展示“信息不足时模型如何提问”的简短交互示例，但这会显著增加提示词长度，且当前文本指令已足够明确，并非必需。
- 此版本提示词可作为企业级架构设计咨询的标准化、高质量交互模板。建议直接投入使用，并在实际使用中收集反馈，进行基于特定场景的微调（如增加特定行业的技术栈偏好约束）。
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词经过本次优化，在清晰度与精确性上达到了新的高度。对任务指令第2点的修改（增加“信息不足以启动有效的架构设计”和“在获得充分信息前暂停后续设计步骤”）是决定性的改进。它明确界定了模型何时应中断流程并寻求输入，消除了模型在信息不足时“硬着头皮”生成低质量方案的潜在风险，使指令的边界和预期行为极其清晰。
- 结构与逻辑： 结构保持严谨。新增的优化点被无缝整合到任务指令的逻辑流中，作为整个设计流程的“质量门禁”，强化了从“需求接收与澄清”到“方案设计”之间的逻辑依赖关系，使整体工作流更加健壮和专业化。
- 安全与对齐： 安全与对齐性保持不变，处于优秀水平。明确要求“在获得充分信息前暂停”，也间接提升了安全性，因为它避免了模型在理解不充分的情况下可能做出的不当技术推荐或假设。
- 模型适配性： 任务完全适配模型能力。要求模型判断“信息是否足够”并据此决定交互行为（提问或继续），属于模型基于上下文进行逻辑判断的范畴，是其核心能力的合理运用。优化使模型的交互行为更符合专业工作场景。
- 有效性潜力： 本次优化显著提升了提示词的有效性潜力。它从根本上确保了输出质量的下限。通过强制在信息不足时进行澄清，极大地增加了最终生成的架构方案与用户真实需求匹配的可能性，避免了大量无效的“垃圾进，垃圾出”场景。结合原有的详尽约束和高质量示例，该提示词引导模型产出高价值、可执行ADR的潜力已最大化。

## 优化建议

- 当前提示词在功能性、清晰度和专业性上均已臻于完善。若需进一步微调，可考虑在“少样本示例”部分，增加一个展示“信息不足时模型如何提问”的简短交互示例，但这会显著增加提示词长度，且当前文本指令已足够明确，并非必需。
- 此版本提示词可作为企业级架构设计咨询的标准化、高质量交互模板。建议直接投入使用，并在实际使用中收集反馈，进行基于特定场景的微调（如增加特定行业的技术栈偏好约束）。
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 提示词经过本次优化，在清晰度与精确性上达到了新的高度。对任务指令第2点的修改（增加“信息不足以启动有效的架构设计”和“在获得充分信息前暂停后续设计步骤”）是决定性的改进。它明确界定了模型何时应中断流程并寻求输入，消除了模型在信息不足时“硬着头皮”生成低质量方案的潜在风险，使指令的边界和预期行为极其清晰。
- 结构与逻辑： 结构保持严谨。新增的优化点被无缝整合到任务指令的逻辑流中，作为整个设计流程的“质量门禁”，强化了从“需求接收与澄清”到“方案设计”之间的逻辑依赖关系，使整体工作流更加健壮和专业化。
- 安全与对齐： 安全与对齐性保持不变，处于优秀水平。明确要求“在获得充分信息前暂停”，也间接提升了安全性，因为它避免了模型在理解不充分的情况下可能做出的不当技术推荐或假设。
- 模型适配性： 任务完全适配模型能力。要求模型判断“信息是否足够”并据此决定交互行为（提问或继续），属于模型基于上下文进行逻辑判断的范畴，是其核心能力的合理运用。优化使模型的交互行为更符合专业工作场景。
- 有效性潜力： 本次优化显著提升了提示词的有效性潜力。它从根本上确保了输出质量的下限。通过强制在信息不足时进行澄清，极大地增加了最终生成的架构方案与用户真实需求匹配的可能性，避免了大量无效的“垃圾进，垃圾出”场景。结合原有的详尽约束和高质量示例，该提示词引导模型产出高价值、可执行ADR的潜力已最大化。

## 优化建议

- 当前提示词在功能性、清晰度和专业性上均已臻于完善。若需进一步微调，可考虑在“少样本示例”部分，增加一个展示“信息不足时模型如何提问”的简短交互示例，但这会显著增加提示词长度，且当前文本指令已足够明确，并非必需。
- 此版本提示词可作为企业级架构设计咨询的标准化、高质量交互模板。建议直接投入使用，并在实际使用中收集反馈，进行基于特定场景的微调（如增加特定行业的技术栈偏好约束）。
