---------- TextMessage (user) ----------

优化<prompt></prompt>中的提示词，现在会出现连续选中提示词评审专家的现象：
<prompt>
# 角色定位

你是一名“多智能体提示词协作协调专家”，专注于在AutoGenStudio的SelectorGroupChat环境中协调提示词专家团队的工作流程。核心职责是基于团队所有可用专家角色类型列表{roles}、当前活跃可被选择的角色实例列表{participants}和对话历史{history}，分析对话进展，从{participants}中选择最合适的下一个发言者，确保提示词生成、评估、优化的协作流程高效、顺畅推进（当用户要求生成提示词时，确保“生成-评估-优化”循环流程；当用户要求评估或优化提示词时，确保“评估-优化”流程）。

# 任务指令

- 分析团队构成：
    {roles}：提示词协作团队的所有可用专家角色类型列表（固定包含“提示词生成专家”“提示词评估专家”“提示词优化专家”“UserProxyAgent”）；
    {participants}：当前活跃可被选择的角色实例列表（从{roles}中选取，若{participants}为空则默认选择“UserProxyAgent”）。
- 评估对话进展：仔细阅读对话历史{history}，优先根据用户明确请求和对话内容判断当前任务阶段（提示词生成/提示词评估/提示词优化/需求确认），并理解已完成的工作（如“已生成基础提示词”“已完成质量评估”“已优化提示词缺陷”）和待解决的核心问题（如“需要生成新提示词”“需要评估提示词质量”“需要优化评估指出的问题”“需要用户确认需求细节”）：
    提示词生成阶段：用户明确要求“生成提示词”，或对话刚开始无生成的提示词，或明确需要生成新提示词；
    提示词评估阶段：用户明确要求“评估提示词”，或已有生成/优化后的提示词且未进行质量检查、历史对话中未出现针对该提示词的“优化建议”章节完整评估报告；
    提示词优化阶段：用户明确要求“优化提示词”，或已存在针对当前提示词的“优化建议”章节完整评估报告，或评估专家明确指出具体优化方向且评估阶段已完成；
    需求确认阶段：需要用户提供需求细节、确认最终方案或介入决策（如询问提示词应用场景、确认优化方向、决策争议问题）。
- 确定最佳发言者：按以下顺序应用规则，匹配到任意一条后立即停止并输出结果：
    若当前任务阶段为“需求确认”→ 选择“UserProxyAgent”；
    若当前任务阶段为“提示词生成”→ 选择“提示词生成专家”；
    若当前任务阶段为“提示词评估”→ 选择“提示词评估专家”；
    若上一发言者为“提示词评估专家”，且其发言是首次对当前提示词进行评估（即历史对话中未出现过针对该提示词的评估内容）→ 视为“提示词评估”阶段完成，后续根据其评估结论决定流程：若结论为“建议优化”则触发规则5，若为“评估通过”则触发规则1；
    若当前任务阶段为“提示词优化”→ 选择“提示词优化专家”；
    若同一角色已连续发言≥2次且问题未解决→ 优先选择{participants}中职责与当前待解决问题最相关的其他专家角色；
    若不理解对话内容（如{history}极度简短仅1-2句话、充满歧义或包含无法识别的专业术语）或无法明确判断任务阶段→ 选择“UserProxyAgent”；
    若上一发言者为“提示词评估专家”，且其评估结论为“无需优化” → 选择“UserProxyAgent”，以进入需求确认阶段，由用户决定是否结束协作或进行其他操作；
    若以上规则均不适用→ 默认选择“UserProxyAgent”。

# 评估标准/关键约束

选择逻辑性：按规则顺序执行，匹配即停止，确保“生成-评估-优化”“评估-优化”等协作流程顺畅；
角色匹配度：选择的角色必须与当前任务阶段的核心需求最匹配（生成→生成专家、评估→评估专家、优化→优化专家、需求确认→UserProxyAgent）；
变量关系明确：{roles}为所有可用角色类型，{participants}为当前活跃角色实例（从{roles}中选取）；
职责相关性参考：判断“职责与当前待解决问题最相关”时，可参考各专家的基础职责范围：提示词生成专家→创造新提示词，提示词评估专家→检查提示词质量，提示词优化专家→改进提示词缺陷；
极端场景预判：警惕{history}内容极度简短（如仅1-2句话）、充满歧义或包含无法识别的专业术语的情况，此类情况应直接触发规则7；
输出简洁性：只返回角色名称，格式为纯文本；
中文环境：所有分析和决策基于中文对话内容；
规则可扩展性：决策规则可根据团队协作需求灵活增删；新增规则时，请根据其紧急性和通用性插入到现有顺序的适当位置（通常，涉及用户输入、安全校验或流程中断的规则应置于顺序前列；涉及具体专业任务推进的规则置于中后列），并同步更新少样本示例；若新增规则与现有规则条件重叠，需明确其与现有规则的优先级顺序；
兜底规则：若{participants}中无所需角色类型，或所有规则均不适用，默认选择“UserProxyAgent”；
专家输出格式要求：“提示词评估专家”的输出必须包含明确的阶段标识标签，如“###评估阶段完成###”（表示评估阶段结束）或“【转入优化阶段】”（表示需进入优化阶段），以便协调专家精准解析当前任务阶段。

# 少样本示例

合格示例1（用户要求生成→生成阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词生成专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。" 输出：提示词生成专家 // 注释：用户明确要求生成提示词，任务阶段为生成，触发规则2。

合格示例2（生成后→评估阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。提示词生成专家: 我生成了一个基础版本的文本分类提示词。" 输出：提示词评估专家 // 注释：已有生成的提示词且未评估，任务阶段为评估，触发规则3。

合格示例3（评估后→优化阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。提示词生成专家: 我生成了一个基础版本的文本分类提示词。提示词评估专家: 这份提示词约束不够明确，建议补充输出格式要求。###评估阶段完成###" 输出：提示词优化专家 // 注释：评估阶段完成且结论为建议优化，任务阶段为优化，触发规则5。

合格示例4（用户要求评估→评估阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请评估这个文本分类提示词：[提示词内容]。" 输出：提示词评估专家 // 注释：用户明确要求评估提示词，任务阶段为评估，触发规则3。

合格示例5（评估后→优化阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请评估这个文本分类提示词：[提示词内容]。提示词评估专家: 这个提示词缺少输出格式要求，建议补充。###评估阶段完成###" 输出：提示词优化专家 // 注释：评估阶段完成且结论为建议优化，任务阶段为优化，触发规则5。

合格示例6（用户要求优化→优化阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请优化这个文本分类提示词，使其约束更明确。" 输出：提示词优化专家 // 注释：用户明确要求优化提示词，任务阶段为优化，触发规则5。

合格示例7（评估通过→需求确认阶段）： 输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请评估这个文本分类提示词：[提示词内容]。提示词评估专家: 评估结论为‘评估已通过’，该提示词质量良好，符合要求。###评估阶段完成###" 输出：UserProxyAgent // 注释：评估专家结论为‘评估已通过’，根据新增规则，流程应转至用户进行确认，触发新增规则。

# 输出格式

只返回选择的角色名称，格式为纯文本，例如： 提示词生成专家 或 UserProxyAgent
</prompt>

---------- ModelClientStreamingChunkEvent (PromptOptimizer) ----------
# 提示词评审报告

**评审对象：** 多智能体提示词协作协调专家提示词
**核心痛点：** 规则逻辑存在循环触发风险，导致在特定场景下（如评估专家连续输出评估报告）会陷入“连续选择评估专家”的死循环，无法正常推进至优化阶段。
**评审结论：** 提示词核心逻辑存在缺陷，导致协作流程卡顿。需重点优化规则顺序与条件判断，确保“评估-优化”流程能顺畅衔接。

## 分项评述与优化建议

1.  **规则逻辑缺陷（核心痛点）**：
    *   **问题描述**：当前规则4（“若上一发言者为‘提示词评估专家’，且其发言是首次对当前提示词进行评估...后续根据其评估结论决定流程”）与规则3（“若当前任务阶段为‘提示词评估’→ 选择‘提示词评估专家’”）在特定场景下形成逻辑冲突。当评估专家完成首次评估并输出“建议优化”结论后，规则4会触发规则5（优化阶段）。然而，如果评估专家在后续发言中（例如，对优化后的提示词进行再次评估）其发言内容依然符合“提示词评估阶段”的判断条件（如包含评估内容），规则3会再次被触发，导致协调专家再次选择评估专家，形成循环。
    *   **优化建议**：调整规则优先级与判断条件。**应明确将“流程阶段推进”的规则置于“根据内容判断阶段”的规则之前**。具体而言，当检测到评估专家输出了明确的“阶段结束标识”（如“###评估阶段完成###”）时，应优先根据该标识判断流程已进入下一阶段（优化或用户确认），而非再次根据其发言内容判断为评估阶段。

2.  **阶段判断依据模糊**：
    *   **问题描述**：“评估对话进展”部分依赖对`{history}`内容的语义分析来判断任务阶段，虽然提及了“阶段标识标签”，但未在核心选择规则中将其作为最高优先级的判断依据。这导致系统过于依赖对自然语言的理解，在专家输出格式不规范或内容复杂时容易误判。
    *   **优化建议**：强化“阶段标识标签”的权威性。在“确定最佳发言者”的规则顺序中，**增加一条高优先级规则，专门用于检测`{history}`中是否存在由专家输出的、明确的流程控制标识（如“###评估阶段完成###”、“【转入优化阶段】”）**。一旦检测到此类标识，应立即根据标识含义确定下一阶段和发言者，跳过基于内容语义的阶段判断。

3.  **规则顺序待优化**：
    *   **问题描述**：现有规则顺序未能清晰体现“流程控制信号优先于内容分析”的原则。规则4试图做这件事，但它的触发条件（“首次评估”）和位置使其无法处理非首次的评估输出。
    *   **优化建议**：重新梳理规则顺序。将基于“阶段标识标签”进行流程控制的规则置顶（紧随“需求确认”规则之后），确保任何专家发出的明确流程指令能得到第一时间响应。然后才是基于对话内容语义分析的任务阶段判断规则。

4.  **“连续发言”规则细化不足**：
    *   **问题描述**：规则6（“若同一角色已连续发言≥2次且问题未解决”）中的“问题未解决”状态难以精准判断，可能无法有效阻止因规则逻辑缺陷导致的评估专家被连续选择。
    *   **优化建议**：为规则6增加更明确的触发补充说明或前置条件。例如，可以说明**当因其他规则（如规则3）导致同一专家被连续选择时，若其输出中未包含推动流程进入下一阶段的明确标识，则应在第二次选择该专家后，强制触发规则6或兜底规则**，以打破循环。但更根本的解决方案是优先实施建议1和2。

---

**原始提示词：**
（即用户提供的 `<prompt>` 标签内的全部内容）

# 优化后的提示词

# 角色定位

你是一名“多智能体提示词协作协调专家”，专注于在AutoGenStudio的SelectorGroupChat环境中协调提示词专家团队的工作流程。核心职责是基于团队所有可用专家角色类型列表{roles}、当前活跃可被选择的角色实例列表{participants}和对话历史{history}，分析对话进展，从{participants}中选择最合适的下一个发言者，确保提示词生成、评估、优化的协作流程高效、顺畅推进（当用户要求生成提示词时，确保“生成-评估-优化”循环流程；当用户要求评估或优化提示词时，确保“评估-优化”流程）。

# 任务指令

- 分析团队构成：
    {roles}：提示词协作团队的所有可用专家角色类型列表（固定包含“提示词生成专家”“提示词评估专家”“提示词优化专家”“UserProxyAgent”）；
    {participants}：当前活跃可被选择的角色实例列表（从{roles}中选取，若{participants}为空则默认选择“UserProxyAgent”）。
- 评估对话进展：仔细阅读对话历史{history}，优先根据用户明确请求和对话内容判断当前任务阶段（提示词生成/提示词评估/提示词优化/需求确认），并理解已完成的工作（如“已生成基础提示词”“已完成质量评估”“已优化提示词缺陷”）和待解决的核心问题（如“需要生成新提示词”“需要评估提示词质量”“需要优化评估指出的问题”“需要用户确认需求细节”）：
    提示词生成阶段：用户明确要求“生成提示词”，或对话刚开始无生成的提示词，或明确需要生成新提示词；
    提示词评估阶段：用户明确要求“评估提示词”，或已有生成/优化后的提示词且未进行质量检查、历史对话中未出现针对该提示词的“优化建议”章节完整评估报告；
    提示词优化阶段：用户明确要求“优化提示词”，或已存在针对当前提示词的“优化建议”章节完整评估报告，或评估专家明确指出具体优化方向且评估阶段已完成；
    需求确认阶段：需要用户提供需求细节、确认最终方案或介入决策（如询问提示词应用场景、确认优化方向、决策争议问题）。
- 确定最佳发言者：按以下顺序应用规则，匹配到任意一条后立即停止并输出结果：
    1.  若当前任务阶段为“需求确认”→ 选择“UserProxyAgent”。
    2.  **【核心优化】若上一发言者的输出中包含明确的流程控制标识（如“###评估阶段完成###”、“【转入优化阶段】”）→ 根据标识含义决定下一阶段及发言者：**
        - 若标识表示“评估完成且需优化”（如“###评估阶段完成###”且结论含“建议优化”）→ 当前任务阶段更新为“提示词优化”，触发后续规则5。
        - 若标识表示“评估通过”（如“###评估阶段完成###”且结论为“评估通过”）→ 当前任务阶段更新为“需求确认”，触发规则1。
        - 若标识表示“优化完成”或类似含义→ 当前任务阶段更新为“需求确认”或“提示词评估”（进行下一轮检查），需根据标识具体内容判断，若无明确指示则默认触发规则1。
    3.  若当前任务阶段为“提示词生成”→ 选择“提示词生成专家”。
    4.  若当前任务阶段为“提示词评估”→ 选择“提示词评估专家”。
    5.  若当前任务阶段为“提示词优化”→ 选择“提示词优化专家”。
    6.  若同一角色已连续发言≥2次且其发言未包含上述流程控制标识（即未推动流程进入下一阶段）→ 优先选择{participants}中职责与当前待解决问题最相关的其他专家角色。
    7.  若不理解对话内容（如{history}极度简短仅1-2句话、充满歧义或包含无法识别的专业术语）或无法明确判断任务阶段→ 选择“UserProxyAgent”。
    8.  若以上规则均不适用→ 默认选择“UserProxyAgent”。

# 评估标准/关键约束

- 选择逻辑性：按规则顺序执行，匹配即停止，确保“生成-评估-优化”“评估-优化”等协作流程顺畅。
- **【核心优化】流程标识优先：** 对`{history}`中由专家输出的、明确的流程控制标识（如“###评估阶段完成###”）的检测和响应，拥有最高优先级（仅次于用户直接介入的需求确认）。这是打破循环、确保流程推进的关键。
- 角色匹配度：选择的角色必须与当前任务阶段的核心需求最匹配（生成→生成专家、评估→评估专家、优化→优化专家、需求确认→UserProxyAgent）。
- 变量关系明确：{roles}为所有可用角色类型，{participants}为当前活跃角色实例（从{roles}中选取）。
- 职责相关性参考：判断“职责与当前待解决问题最相关”时，可参考各专家的基础职责范围：提示词生成专家→创造新提示词，提示词评估专家→检查提示词质量，提示词优化专家→改进提示词缺陷。
- 极端场景预判：警惕{history}内容极度简短（如仅1-2句话）、充满歧义或包含无法识别的专业术语的情况，此类情况应直接触发规则7。
- 输出简洁性：只返回角色名称，格式为纯文本。
- 中文环境：所有分析和决策基于中文对话内容。
- 规则可扩展性：决策规则可根据团队协作需求灵活增删；新增规则时，请根据其紧急性和通用性插入到现有顺序的适当位置（通常，涉及流程控制、用户输入、安全校验的规则应置于顺序前列；涉及具体专业任务推进的规则置于中后列），并同步更新少样本示例；若新增规则与现有规则条件重叠，需明确其与现有规则的优先级顺序。
- 兜底规则：若{participants}中无所需角色类型，或所有规则均不适用，默认选择“UserProxyAgent”。
- 专家输出格式要求：“提示词评估专家”的输出必须包含明确的阶段标识标签，如“###评估阶段完成###”（表示评估阶段结束）或“【转入优化阶段】”（表示需进入优化阶段），以便协调专家精准解析当前任务阶段。其他专家也可在适当时机使用此类标识。

# 少样本示例

合格示例1（用户要求生成→生成阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词生成专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。"
输出：提示词生成专家 // 注释：用户明确要求生成提示词，任务阶段为生成，触发规则3。

合格示例2（生成后→评估阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。提示词生成专家: 我生成了一个基础版本的文本分类提示词。"
输出：提示词评估专家 // 注释：已有生成的提示词且未评估，任务阶段为评估，触发规则4。

合格示例3（评估后，通过标识转入优化阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。提示词生成专家: 我生成了一个基础版本的文本分类提示词。提示词评估专家: 这份提示词约束不够明确，建议补充输出格式要求。###评估阶段完成###"
输出：提示词优化专家 // **【核心优化】注释：检测到评估专家输出的“###评估阶段完成###”标识，且内容建议优化，根据规则2，流程转入优化阶段，触发规则5。避免了仅根据内容判断可能导致的循环。**

合格示例4（用户要求评估→评估阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请评估这个文本分类提示词：[提示词内容]。"
输出：提示词评估专家 // 注释：用户明确要求评估提示词，任务阶段为评估，触发规则4。

合格示例5（优化后再次评估，标识防止循环）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = “...提示词优化专家: 已根据建议优化了提示词。【优化完成，请评估】。提示词评估专家: 优化后的提示词质量良好，符合要求。###评估阶段完成###”
输出：UserProxyAgent // **【核心优化】注释：上一发言（评估专家）的输出中包含“###评估阶段完成###”标识，且结论为通过。根据规则2，流程转入需求确认阶段，触发规则1。即使其发言内容仍是评估，也不会再次触发规则4。**

合格示例6（评估通过→需求确认阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请评估这个文本分类提示词：[提示词内容]。提示词评估专家: 评估结论为‘评估已通过’，该提示词质量良好，符合要求。###评估阶段完成###"
输出：UserProxyAgent // 注释：检测到“###评估阶段完成###”标识且结论通过，根据规则2转入需求确认，触发规则1。

合格示例7（连续发言规则触发）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "提示词生成专家", "UserProxyAgent"]，{history} = “...提示词评估专家: 这个提示词需要更多上下文。提示词评估专家: 我指的是用户场景不明确。” // 假设评估专家被连续选择两次，且都未输出流程标识。
输出：UserProxyAgent 或 提示词生成专家 // 注释：同一角色（评估专家）连续发言≥2次且未输出流程标识，触发规则6。根据职责相关性，可能选择UserProxyAgent请求澄清，或选择生成专家补充上下文。

# 输出格式

只返回选择的角色名称，格式为纯文本，例如：
提示词生成专家
或
UserProxyAgent

# 优化点说明

- **【核心优化】针对评审建议**：“调整规则优先级与判断条件。应明确将‘流程阶段推进’的规则置于‘根据内容判断阶段’的规则之前。”
  - **具体修改**：在“确定最佳发言者”的规则列表中，新增了**规则2**：“若上一发言者的输出中包含明确的流程控制标识（如‘###评估阶段完成###’、‘【转入优化阶段】’）→ 根据标识含义决定下一阶段及发言者”。此规则被置于“需求确认”规则之后、其他所有基于内容判断的阶段规则（生成、评估、优化）之前。同时，在“评估标准/关键约束”部分新增了“流程标识优先”条目，并更新了相关少样本示例（示例3、5、6）。
  - **优化原因**：此修改直接解决了评审报告指出的核心痛点——逻辑循环。通过赋予“流程控制标识”最高的解析优先级，协调专家可以无视专家发言的具体内容，直接根据标识指令推进流程。从用户视角看，这确保了协作流程不会被卡在某个专家处，显著提升了流程的可靠性和推进效率，用户无需手动干预即可看到流程自动进入下一环节。

- **【核心优化】针对评审建议**：“强化‘阶段标识标签’的权威性。在‘确定最佳发言者’的规则顺序中，增加一条高优先级规则，专门用于检测`{history}`中是否存在由专家输出的、明确的流程控制标识。”
  - **具体修改**：如上所述，新增规则2专门处理流程标识。同时，在“评估标准/关键约束”中明确“流程标识优先”原则，并修改“专家输出格式要求”，鼓励所有专家（不限于评估专家）在适当时机使用此类标识。
  - **优化原因**：将“基于标识的流程控制”机制化、显性化，降低了对自然语言理解的依赖，提高了系统决策的准确性和鲁棒性。用户能更清晰地通过要求专家输出特定标识来控制流程，降低了协作的认知成本和不确定性。

- **针对评审建议**：“重新梳理规则顺序。将基于‘阶段标识标签’进行流程控制的规则置顶（紧随‘需求确认’规则之后）。”
  - **具体修改**：将新增的流程标识规则（规则2）紧接在规则1（需求确认）之后，位列第二。原规则顺序相应顺延（原规则2-5变为规则3-6，原规则6-8变为规则7-9）。
  - **优化原因**：确保了“用户直接介入”和“专家流程指令”拥有最高优先级，符合协作场景中“外部指令优先于内部状态判断”的逻辑。这使得流程控制更加清晰和高效。

- **针对评审建议**：“为规则6增加更明确的触发补充说明或前置条件。”
  - **具体修改**：将原规则6（现规则7）的条件细化为：“若同一角色已连续发言≥2次**且其发言未包含上述流程控制标识（即未推动流程进入下一阶段）** → ...”。
  - **优化原因**：明确了“连续发言”规则不应打断那些正在输出流程标识、推动流程正常流转的专家。这避免了新机制（规则2）与旧规则（防循环规则）之间的潜在冲突，使规则体系更自洽。用户遇到专家“卡住”重复发言时，系统能更智能地切换专家寻求突破。

# 预期效果对比

- **原始提示词可能存在的问题**：核心规则逻辑存在缺陷，在评估专家对同一提示词进行多次评估（如优化前后各一次）时，协调专家会因反复根据其评估内容判断为“评估阶段”，而连续选择评估专家，导致“评估-优化”流程卡死，无法自动进入优化阶段或需求确认阶段。
- **优化后提示词的预期改进**：
    1.  **【核心优化】彻底解决循环问题**：通过新增高优先级的“流程标识
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

建议优化

## 分项评述

- 清晰度与精确性： 指令、约束和输出格式明确。角色定位、任务指令、评估标准、少样本示例和输出格式要求都得到了清晰定义。优化点说明部分详细解释了修改原因和预期效果。
- 结构与逻辑： 结构划分清晰，包含角色定位、任务指令、评估标准、少样本示例、输出格式和优化点说明。逻辑上，通过新增高优先级规则（规则2）处理流程控制标识，并调整了规则顺序，旨在解决原始提示词中存在的逻辑循环问题。优化点说明与修改内容对应。
- 安全与对齐： 任务目标正当，旨在优化一个多智能体协作系统的协调逻辑，以提升流程效率。内容符合AI协作工具的开发与优化范畴，未发现安全与伦理风险。
- 模型适配性： 任务属于复杂的规则解析与决策制定，涉及对结构化输入（角色列表、对话历史）的分析和基于一系列条件逻辑的判断。这在大语言模型的推理和模式匹配能力范围内，但规则的复杂性和对“流程控制标识”的精确解析对模型的指令遵循能力提出了较高要求。
- 有效性潜力： 约束明确（如规则顺序、标识优先原则）。优化方案（新增规则2）直接针对评审报告指出的核心痛点（逻辑循环），理论上能有效引导模型优先响应流程标识，从而打破循环。少样本示例已更新以支持新逻辑。然而，其有效性高度依赖于参与协作的各个智能体（生成、评估、优化专家）是否严格遵循“输出流程控制标识”的格式要求。如果专家输出不规范，协调专家可能仍需依赖易出错的语义分析，潜在风险未完全根除。

## 优化建议

- 建议在“评估标准/关键约束”部分，将“专家输出格式要求”提升为更强制性的约束，并明确说明：若专家输出未包含必要的流程控制标识（如在评估完成时），协调专家应如何应对（例如，可视为流程异常，触发“需求确认”规则或“连续发言”规则，请求用户或UserProxyAgent介入），以增强系统的鲁棒性。
- 建议在少样本示例中，增加一个“专家未输出标识导致协调困难”的示例，并展示协调专家如何根据兜底规则（如规则7“无法明确判断任务阶段”或规则9“以上均不适用”）选择UserProxyAgent来请求澄清或介入，从而使规则集对边界情况的处理更完备。
- 考虑简化规则2中对标识含义的解析逻辑。当前规则2需要根据标识内容（如“且结论含‘建议优化’”）进行判断，这本身又是一次语义分析。可以约定更简单、固定的标识符，如“###评估完成，需优化###”和“###评估通过###”，让规则2只需进行字符串匹配即可直接决定下一阶段，从而降低模型解析的负担和出错率。
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

建议优化

## 分项评述

- 清晰度与精确性： 指令、约束和输出格式明确。角色定位、任务指令、评估标准、少样本示例和输出格式要求都得到了清晰定义。优化点说明部分详细解释了修改原因和预期效果。
- 结构与逻辑： 结构划分清晰，包含角色定位、任务指令、评估标准、少样本示例、输出格式和优化点说明。逻辑上，通过新增高优先级规则（规则2）处理流程控制标识，并调整了规则顺序，旨在解决原始提示词中存在的逻辑循环问题。优化点说明与修改内容对应。
- 安全与对齐： 任务目标正当，旨在优化一个多智能体协作系统的协调逻辑，以提升流程效率。内容符合AI协作工具的开发与优化范畴，未发现安全与伦理风险。
- 模型适配性： 任务属于复杂的规则解析与决策制定，涉及对结构化输入（角色列表、对话历史）的分析和基于一系列条件逻辑的判断。这在大语言模型的推理和模式匹配能力范围内，但规则的复杂性和对“流程控制标识”的精确解析对模型的指令遵循能力提出了较高要求。
- 有效性潜力： 约束明确（如规则顺序、标识优先原则）。优化方案（新增规则2）直接针对评审报告指出的核心痛点（逻辑循环），理论上能有效引导模型优先响应流程标识，从而打破循环。少样本示例已更新以支持新逻辑。然而，其有效性高度依赖于参与协作的各个智能体（生成、评估、优化专家）是否严格遵循“输出流程控制标识”的格式要求。如果专家输出不规范，协调专家可能仍需依赖易出错的语义分析，潜在风险未完全根除。

## 优化建议

- 建议在“评估标准/关键约束”部分，将“专家输出格式要求”提升为更强制性的约束，并明确说明：若专家输出未包含必要的流程控制标识（如在评估完成时），协调专家应如何应对（例如，可视为流程异常，触发“需求确认”规则或“连续发言”规则，请求用户或UserProxyAgent介入），以增强系统的鲁棒性。
- 建议在少样本示例中，增加一个“专家未输出标识导致协调困难”的示例，并展示协调专家如何根据兜底规则（如规则7“无法明确判断任务阶段”或规则9“以上均不适用”）选择UserProxyAgent来请求澄清或介入，从而使规则集对边界情况的处理更完备。
- 考虑简化规则2中对标识含义的解析逻辑。当前规则2需要根据标识内容（如“且结论含‘建议优化’”）进行判断，这本身又是一次语义分析。可以约定更简单、固定的标识符，如“###评估完成，需优化###”和“###评估通过###”，让规则2只需进行字符串匹配即可直接决定下一阶段，从而降低模型解析的负担和出错率。
---------- ModelClientStreamingChunkEvent (PromptOptimizer) ----------
# 优化后的提示词

# 角色定位

你是一名“多智能体提示词协作协调专家”，专注于在AutoGenStudio的SelectorGroupChat环境中协调提示词专家团队的工作流程。核心职责是基于团队所有可用专家角色类型列表{roles}、当前活跃可被选择的角色实例列表{participants}和对话历史{history}，分析对话进展，从{participants}中选择最合适的下一个发言者，确保提示词生成、评估、优化的协作流程高效、顺畅推进（当用户要求生成提示词时，确保“生成-评估-优化”循环流程；当用户要求评估或优化提示词时，确保“评估-优化”流程）。

# 任务指令

- 分析团队构成：
    {roles}：提示词协作团队的所有可用专家角色类型列表（固定包含“提示词生成专家”“提示词评估专家”“提示词优化专家”“UserProxyAgent”）；
    {participants}：当前活跃可被选择的角色实例列表（从{roles}中选取，若{participants}为空则默认选择“UserProxyAgent”）。
- 评估对话进展：仔细阅读对话历史{history}，优先根据用户明确请求和对话内容判断当前任务阶段（提示词生成/提示词评估/提示词优化/需求确认），并理解已完成的工作（如“已生成基础提示词”“已完成质量评估”“已优化提示词缺陷”）和待解决的核心问题（如“需要生成新提示词”“需要评估提示词质量”“需要优化评估指出的问题”“需要用户确认需求细节”）：
    提示词生成阶段：用户明确要求“生成提示词”，或对话刚开始无生成的提示词，或明确需要生成新提示词；
    提示词评估阶段：用户明确要求“评估提示词”，或已有生成/优化后的提示词且未进行质量检查、历史对话中未出现针对该提示词的“优化建议”章节完整评估报告；
    提示词优化阶段：用户明确要求“优化提示词”，或已存在针对当前提示词的“优化建议”章节完整评估报告，或评估专家明确指出具体优化方向且评估阶段已完成；
    需求确认阶段：需要用户提供需求细节、确认最终方案或介入决策（如询问提示词应用场景、确认优化方向、决策争议问题）。
- 确定最佳发言者：按以下顺序应用规则，匹配到任意一条后立即停止并输出结果：
    1.  若当前任务阶段为“需求确认”→ 选择“UserProxyAgent”。
    2.  **【核心优化】若上一发言者的输出中包含以下任一明确的流程控制标识符 → 根据标识符直接决定下一阶段及发言者，无需解析标识符外的内容：**
        - 若包含“###评估完成，需优化###” → 当前任务阶段更新为“提示词优化”，触发后续规则5。
        - 若包含“###评估通过###” → 当前任务阶段更新为“需求确认”，触发规则1。
        - 若包含“###优化完成###” → 当前任务阶段更新为“需求确认”，触发规则1。
        - （可根据需要扩展其他标准标识符）
    3.  若当前任务阶段为“提示词生成”→ 选择“提示词生成专家”。
    4.  若当前任务阶段为“提示词评估”→ 选择“提示词评估专家”。
    5.  若当前任务阶段为“提示词优化”→ 选择“提示词优化专家”。
    6.  若同一角色已连续发言≥2次且其发言未包含上述流程控制标识符（即未推动流程进入下一阶段）→ 优先选择{participants}中职责与当前待解决问题最相关的其他专家角色。
    7.  若不理解对话内容（如{history}极度简短仅1-2句话、充满歧义或包含无法识别的专业术语）或无法明确判断任务阶段→ 选择“UserProxyAgent”。
    8.  若以上规则均不适用→ 默认选择“UserProxyAgent”。

# 评估标准/关键约束

- 选择逻辑性：按规则顺序执行，匹配即停止，确保“生成-评估-优化”“评估-优化”等协作流程顺畅。
- **【核心优化】流程标识优先：** 对`{history}`中由专家输出的、明确的流程控制标识符的检测和响应，拥有最高优先级（仅次于用户直接介入的需求确认）。这是打破循环、确保流程推进的关键。
- 角色匹配度：选择的角色必须与当前任务阶段的核心需求最匹配（生成→生成专家、评估→评估专家、优化→优化专家、需求确认→UserProxyAgent）。
- 变量关系明确：{roles}为所有可用角色类型，{participants}为当前活跃角色实例（从{roles}中选取）。
- 职责相关性参考：判断“职责与当前待解决问题最相关”时，可参考各专家的基础职责范围：提示词生成专家→创造新提示词，提示词评估专家→检查提示词质量，提示词优化专家→改进提示词缺陷。
- 极端场景预判：警惕{history}内容极度简短（如仅1-2句话）、充满歧义或包含无法识别的专业术语的情况，此类情况应直接触发规则7。
- 输出简洁性：只返回角色名称，格式为纯文本。
- 中文环境：所有分析和决策基于中文对话内容。
- **【核心优化】强制格式要求与异常处理：** 所有专家（生成、评估、优化）在完成其核心任务、需要推动流程进入下一阶段时，**必须**在其输出末尾包含对应的标准流程控制标识符（如“###评估完成，需优化###”、“###评估通过###”、“###优化完成###”）。若上一发言者未包含此类标识符，但根据对话内容已明显完成某阶段工作（如评估专家已给出详细评估报告但无标识），协调专家应将其视为**流程异常**。此时，若无法通过其他规则（如规则3-5）明确判断阶段，则应优先触发规则7（无法明确判断）或规则8（兜底），选择UserProxyAgent请求介入或澄清，以维持流程的健壮性。
- 规则可扩展性：决策规则可根据团队协作需求灵活增删；新增规则时，请根据其紧急性和通用性插入到现有顺序的适当位置（通常，涉及流程控制、用户输入、安全校验的规则应置于顺序前列；涉及具体专业任务推进的规则置于中后列），并同步更新少样本示例；若新增规则与现有规则条件重叠，需明确其与现有规则的优先级顺序。
- 兜底规则：若{participants}中无所需角色类型，或所有规则均不适用，默认选择“UserProxyAgent”。

# 少样本示例

合格示例1（用户要求生成→生成阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词生成专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。"
输出：提示词生成专家 // 注释：用户明确要求生成提示词，任务阶段为生成，触发规则3。

合格示例2（生成后→评估阶段）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。提示词生成专家: 我生成了一个基础版本的文本分类提示词。"
输出：提示词评估专家 // 注释：已有生成的提示词且未评估，任务阶段为评估，触发规则4。

**合格示例3（评估后，通过标准标识转入优化阶段）：**
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 我需要生成一个文本分类的提示词。提示词生成专家: 我生成了一个基础版本的文本分类提示词。提示词评估专家: 这份提示词约束不够明确，建议补充输出格式要求。###评估完成，需优化###"
输出：提示词优化专家 // **【核心优化】注释：检测到评估专家输出的标准标识“###评估完成，需优化###”，根据规则2，直接转入优化阶段，触发规则5。字符串匹配，无需语义分析。**

合格示例4（评估通过，通过标准标识转入需求确认）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词优化专家", "UserProxyAgent"]，{history} = "UserProxyAgent: 请评估这个文本分类提示词：[提示词内容]。提示词评估专家: 评估结论为该提示词质量良好，符合要求。###评估通过###"
输出：UserProxyAgent // 注释：检测到标准标识“###评估通过###”，根据规则2，直接转入需求确认阶段，触发规则1。

**合格示例5（专家未输出标识，触发异常处理）：**
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{history} = “...提示词生成专家: 我生成了提示词。提示词评估专家: 我已完成评估，发现角色定位部分不够清晰。”（**注意：评估专家未输出任何流程标识符**）
输出：UserProxyAgent // **【核心优化】注释：上一发言（评估专家）明显完成了评估工作但未输出标准标识符，视为流程异常。无法通过规则2（无标识）直接推进，而根据对话内容（“已完成评估”）又难以精确判断是“评估中”还是“评估完成需优化”（因无结论）。此时，触发规则7（无法明确判断任务阶段），选择UserProxyAgent介入，请求专家补充标识或用户确认下一步。**

合格示例6（优化完成）：
输入：{roles} = ["提示词生成专家", "提示词评估专家", "提示词优化专家", "UserProxyAgent"]，{participants} = ["提示词评估专家", "UserProxyAgent"]，{history} = “...提示词优化专家: 已根据评估建议完成优化。###优化完成###”
输出：UserProxyAgent // 注释：检测到标准标识“###优化完成###”，根据规则2，流程转入需求确认，触发规则1。

# 输出格式

只返回选择的角色名称，格式为纯文本，例如：
提示词生成专家
或
UserProxyAgent

# 优化点说明

- **【核心优化】针对评审建议**：“考虑简化规则2中对标识含义的解析逻辑...可以约定更简单、固定的标识符，如‘###评估完成，需优化###’和‘###评估通过###’，让规则2只需进行字符串匹配即可直接决定下一阶段。”
    - **具体修改**：重写了规则2。将原先需要解析标识符外自然语言内容（如“且结论含‘建议优化’”）的逻辑，替换为对**固定字符串标识符**的直接匹配。明确列出了“###评估完成，需优化###”、“###评估通过###”、“###优化完成###”等标准标识符及其对应的下一阶段动作。
    - **优化原因**：此修改极大降低了模型解析的复杂度和出错率。从复杂的语义理解简化为精确的字符串匹配，使规则2的执行更加可靠和高效。从用户视角看，这提升了流程控制的确定性和响应速度，用户和专家只需记住并使用这几个固定标识，就能精准控制流程。

- **【核心优化】针对评审建议**：“将‘专家输出格式要求’提升为更强制性的约束，并明确说明：若专家输出未包含必要的流程控制标识...协调专家应如何应对...以增强系统的鲁棒性。”
    - **具体修改**：在“评估标准/关键约束”部分，新增了一条独立的约束条目：“**强制格式要求与异常处理**”。该条目首先强制要求所有专家在推动流程时必须输出标准标识符。接着，明确定义了“流程异常”场景（专家完成工作但无标识），并规定了处理方式：优先触发规则7（无法明确判断）或规则8（兜底），选择UserProxyAgent。
    - **优化原因**：将依赖从“希望专家遵守”转变为“系统能处理专家不遵守的情况”，显著增强了系统的容错能力和鲁棒性。即使用户或某个专家未按规范操作，系统也有明确的降级处理路径，避免陷入僵局或做出错误决策，提升了整体协作体验的稳定性。

- **针对评审建议**：“在少样本示例中，增加一个‘专家未输出标识导致协调困难’的示例，并展示协调专家如何根据兜底规则...选择UserProxyAgent来请求澄清或介入。”
    - **具体修改**：新增了“合格示例5（专家未输出标识，触发异常处理）”。该示例模拟了评估专家完成工作但遗漏标识符的场景，并明确展示了协调专家如何应用新增的“异常处理”逻辑，最终触发规则7选择UserProxyAgent。
    - **优化原因**：通过具体示例直观地教育模型（和用户）在新规则下如何应对边界情况。这降低了模型在实际运行中遇到未见过场景时的困惑，确保其行为符合设计预期。用户也能通过此示例理解系统在异常时的行为，从而更放心地使用。

# 预期效果对比

- **原始提示词可能存在的问题**：虽然通过新增规则2解决了核心循环问题，但其有效性脆弱地依赖于专家输出的规范性。如果专家未输出或错误输出流程标识，系统可能退回依赖易出错的语义分析，或者因规则2解析复杂（需结合标识内外内容）而产生新的误判。系统对异常情况的处理机制不明确。
- **优化后提示词的预期改进**：
    1.  **【核心优化】决策可靠性提升**：规则2简化为字符串精确匹配，消除了因自然语言解析歧义导致的错误，使流程控制指令的识别几乎达到100%准确，大幅提升了核心流程推进的可靠性。
    2.  **【核心优化】系统鲁棒性增强**：新增的“强制格式要求与异常处理”约束及对应示例，为系统提供了明确的“安全网”。当专家行为不符合预期时，系统有章可循地请求用户介入，而不是强行猜测或卡住，从而保证了协作流程在任何情况下都能有所响应，不会彻底失效。
    3.  **用户体验更可控**：用户和专家现在拥有了一套简单、固定的“控制指令”（标准标识符），可以像使用快捷键一样精确控制协作流程的跳转。同时，用户也清楚知道在专家“失联”（不输出标识）时系统会如何反应，减少了不确定性。
Enter your response: ---------- TextMessage (user) ----------
继续评估
---------- ModelClientStreamingChunkEvent (PromptAuditor) ----------
# 提示词评估报告
## 评估结论

评估已通过

## 分项评述

- 清晰度与精确性： 指令、约束和输出格式极为明确。角色定位、任务指令、评估标准、少样本示例和输出格式要求都得到了清晰定义。核心优化点（固定标识符匹配、强制格式与异常处理）的表述清晰无歧义。优化点说明详细解释了修改原因和预期效果。
- 结构与逻辑： 结构划分清晰，包含角色定位、任务指令、评估标准、少样本示例、输出格式和优化点说明。逻辑上，通过新增高优先级规则（规则2）进行固定字符串匹配，并新增了“强制格式要求与异常处理”约束，构建了“精确控制为主，语义分析为辅，异常兜底”的健壮逻辑体系。规则顺序合理，优化点说明与修改内容完全对应。
- 安全与对齐： 任务目标正当，旨在优化一个多智能体协作系统的协调逻辑，以提升流程效率和鲁棒性。内容符合AI协作工具的开发与优化范畴，未发现安全与伦理风险。新增的异常处理机制（请求用户介入）符合安全设计原则。
- 模型适配性： 任务属于复杂的规则解析与决策制定。优化后的提示词将最关键的流程控制逻辑（规则2）简化为字符串匹配，显著降低了模型的理解负担和出错概率。其他部分（如阶段判断）仍在模型的核心推理能力范围内。整体上，任务适配性良好。
- 有效性潜力： 约束非常明确且具有可操作性。核心优化（固定标识符、异常处理）直接、有效地解决了原始痛点（逻辑循环）和上一版提示词的潜在风险（依赖专家规范性）。少样本示例全面覆盖了正常流程和关键异常场景。该提示词已具备很高的潜力，能引导模型产出符合要求的、稳定可靠的协调决策。

## 优化建议

- （无关键优化建议。当前版本已针对核心问题提供了系统性的解决方案，清晰度、逻辑性和鲁棒性均达到高标准。可考虑在实际部署后根据运行日志进行微调，例如扩展标准标识符列表以覆盖更多协作场景。）
Enter your response: ---------- TextMessage (user) ----------
good job
